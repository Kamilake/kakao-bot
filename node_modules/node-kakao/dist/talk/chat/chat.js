"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TypeMap = exports.CustomChat = exports.ReplyChat = exports.MapChat = exports.SharpSearchChat = exports.FileChat = exports.VideoChat = exports.GifEmoticonChat = exports.AnimatedEmoticonChat = exports.StaticEmoticonChat = exports.EmoticonChat = exports.MultiPhotoChat = exports.SinglePhotoChat = exports.PhotoChat = exports.TextChat = exports.FeedChat = exports.UnknownChat = exports.Chat = void 0;
const chat_type_1 = require("./chat-type");
const __1 = require("../..");
const chat_attachment_1 = require("./attachment/chat-attachment");
const sharp_attachment_1 = require("./attachment/sharp-attachment");
const json_util_1 = require("../../util/json-util");
const chat_feed_1 = require("./chat-feed");
const custom_attachment_1 = require("./attachment/custom-attachment");
const channel_type_1 = require("../channel/channel-type");
const feed_type_1 = require("../feed/feed-type");
const rich_feed_attachment_1 = require("./attachment/rich-feed-attachment");
class Chat {
    constructor(channel, sender, originalType, messageId, logId, prevLogId, sendTime, text, rawAttachment = '{}') {
        this.rawAttachment = {};
        this.channel = channel;
        this.sender = sender;
        this.originalType = originalType;
        this.logId = logId;
        this.prevLogId = prevLogId;
        this.text = text;
        this.messageId = messageId;
        this.sendTime = sendTime;
        this.attachmentList = [];
        this.mentionMap = new Map();
        this.processAttachment(text, rawAttachment);
    }
    get Channel() {
        return this.channel;
    }
    get Sender() {
        return this.sender;
    }
    get PrevLogId() {
        return this.prevLogId;
    }
    get OriginalType() {
        return this.originalType;
    }
    get LogId() {
        return this.logId;
    }
    get MessageId() {
        return this.messageId;
    }
    get Text() {
        return this.text;
    }
    get SendTime() {
        return this.sendTime;
    }
    get AttachmentList() {
        return this.attachmentList;
    }
    get RawAttachment() {
        return this.rawAttachment;
    }
    get MentionMap() {
        return this.mentionMap;
    }
    async markChatRead() {
        await this.channel.markChannelRead(this.logId);
    }
    getMentionContentList() {
        return Array.from(this.mentionMap.values());
    }
    isMentioned(userId) {
        return this.mentionMap.has(userId.toString());
    }
    getUserMentionList(userId) {
        if (!this.isMentioned(userId))
            return null;
        return this.mentionMap.get(userId.toString());
    }
    getMentionCount(userId) {
        let mentionList = this.getUserMentionList(userId);
        if (!mentionList)
            return 0;
        return this.getUserMentionList(userId).IndexList.length;
    }
    isFeed() {
        return this.Type === chat_type_1.ChatType.Feed;
    }
    getFeed() {
        if (!this.isFeed()) {
            throw new Error(`Message ${this.logId.toString()} is not Feed`);
        }
        if (this.feed)
            return this.feed;
        return this.feed = chat_feed_1.ChatFeed.getFeedFromText(this.text);
    }
    processAttachment(text, rawAttachment) {
        if (!rawAttachment || rawAttachment === '') {
            return;
        }
        let json = {};
        try {
            json = json_util_1.JsonUtil.parseLoseless(rawAttachment);
        }
        catch (e) {
        }
        this.rawAttachment = json;
        this.readAttachment(json, this.attachmentList);
        if (json['mentions'])
            this.processMention(json['mentions']);
    }
    processMention(rawMentions) {
        this.mentionMap.clear();
        for (let rawMention of rawMentions) {
            let content = new chat_attachment_1.MentionContentList();
            content.readRawContent(rawMention);
            this.mentionMap.set(content.UserId.toString(), content);
        }
    }
    async replyText(...textFormat) {
        return this.Channel.sendText(...textFormat);
    }
    async replyMedia(template) {
        return this.Channel.sendMedia(template);
    }
    async replyTemplate(template) {
        return this.Channel.sendTemplate(template);
    }
    get Deletable() {
        return this.Sender.isClientUser();
    }
    get Hidable() {
        return this.channel.isOpenChat() && this.channel.Type === channel_type_1.ChannelType.OPENCHAT_GROUP;
    }
    async delete() {
        return this.channel.Client.ChatManager.deleteChat(this.Channel.Id, this.logId);
    }
    async hide() {
        let openChannel = this.channel;
        return openChannel.hideChat(this);
    }
}
exports.Chat = Chat;
class UnknownChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Unknown;
    }
    readAttachment(attachmentJson, attachmentList) {
    }
}
exports.UnknownChat = UnknownChat;
class FeedChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Feed;
    }
    get Feed() {
        return this.getFeed();
    }
    get RichFeedAttachment() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        try {
            if (this.getFeed().feedType === feed_type_1.FeedType.RICH_CONTENT) {
                attachmentList.push(new rich_feed_attachment_1.RichFeedAttachment(attachmentJson['text'], attachmentJson['icon'], attachmentJson['action']));
            }
        }
        catch (e) {
        }
    }
}
exports.FeedChat = FeedChat;
class TextChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Text;
    }
    get LongText() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        if (attachmentJson['path'] && attachmentJson['k'] && attachmentJson['s']) {
            attachmentList.push(new chat_attachment_1.LongTextAttachment(attachmentJson['path'], attachmentJson['k'], attachmentJson['s']));
        }
    }
}
exports.TextChat = TextChat;
class PhotoChat extends Chat {
    get AttachmentList() {
        return super.AttachmentList;
    }
}
exports.PhotoChat = PhotoChat;
class SinglePhotoChat extends PhotoChat {
    get Type() {
        return chat_type_1.ChatType.Photo;
    }
    get Photo() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        let photoAttachment = new __1.PhotoAttachment();
        photoAttachment.readAttachment(attachmentJson);
        attachmentList.push(photoAttachment);
    }
}
exports.SinglePhotoChat = SinglePhotoChat;
class MultiPhotoChat extends PhotoChat {
    get Type() {
        return chat_type_1.ChatType.MultiPhoto;
    }
    readAttachment(attachmentJson, attachmentList) {
        let keyPathList = attachmentJson['kl'];
        for (let i = 0; i < keyPathList.length; i++) {
            let photoAttachment = new __1.PhotoAttachment(attachmentJson['kl'][i], attachmentJson['wl'][i], attachmentJson['hl'][i], attachmentJson['imageUrls'][i], attachmentJson['sl'][i], attachmentJson['mtl'][i], attachmentJson['thumbnailUrls'][i], attachmentJson['thumbnailWidths'][i], attachmentJson['thumbnailHeights'][i]);
            attachmentList.push(photoAttachment);
        }
    }
}
exports.MultiPhotoChat = MultiPhotoChat;
class EmoticonChat extends Chat {
    get Emoticon() {
        return this.AttachmentList[0] || null;
    }
}
exports.EmoticonChat = EmoticonChat;
class StaticEmoticonChat extends EmoticonChat {
    get Type() {
        return chat_type_1.ChatType.Sticker;
    }
    readAttachment(attachmentJson, attachmentList) {
        let attachment = new chat_attachment_1.EmoticonAttachment();
        attachment.readAttachment(attachmentJson);
        attachmentList.push(attachment);
    }
}
exports.StaticEmoticonChat = StaticEmoticonChat;
class AnimatedEmoticonChat extends EmoticonChat {
    get Type() {
        return chat_type_1.ChatType.StickerAni;
    }
    readAttachment(attachmentJson, attachmentList) {
        let attachment = new chat_attachment_1.EmoticonAttachment();
        attachment.readAttachment(attachmentJson);
        attachmentList.push(attachment);
    }
}
exports.AnimatedEmoticonChat = AnimatedEmoticonChat;
class GifEmoticonChat extends EmoticonChat {
    get Type() {
        return chat_type_1.ChatType.StickerAni;
    }
    readAttachment(attachmentJson, attachmentList) {
        let attachment = new chat_attachment_1.EmoticonAttachment();
        attachment.readAttachment(attachmentJson);
        attachmentList.push(attachment);
    }
}
exports.GifEmoticonChat = GifEmoticonChat;
class VideoChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Video;
    }
    get Video() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        let attachment = new chat_attachment_1.VideoAttachment();
        attachment.readAttachment(attachmentJson);
        attachmentList.push(attachment);
    }
}
exports.VideoChat = VideoChat;
class FileChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.File;
    }
    get Map() {
        return this.AttachmentList[0];
    }
    readAttachment(attachmentJson, attachmentList) {
        let attachment = new __1.FileAttachment();
        attachment.readAttachment(attachmentJson);
        attachmentList.push(attachment);
    }
}
exports.FileChat = FileChat;
class SharpSearchChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Search;
    }
    get Sharp() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        let sharpAttachment = new sharp_attachment_1.SharpAttachment();
        sharpAttachment.readAttachment(attachmentJson);
        attachmentList.push(sharpAttachment);
    }
}
exports.SharpSearchChat = SharpSearchChat;
class MapChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Map;
    }
    get Map() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        let mapAttachment = new chat_attachment_1.MapAttachment();
        mapAttachment.readAttachment(attachmentJson);
        attachmentList.push(mapAttachment);
    }
}
exports.MapChat = MapChat;
class ReplyChat extends Chat {
    constructor() {
        super(...arguments);
        this.contentOnly = false;
    }
    get Type() {
        return chat_type_1.ChatType.Reply;
    }
    get ShowContentOnly() {
        return this.contentOnly;
    }
    get Reply() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        let replyAttachment = new chat_attachment_1.ReplyAttachment();
        replyAttachment.readAttachment(attachmentJson);
        attachmentList.push(replyAttachment);
        if (attachmentJson['attach_type']) {
            let contentChat = new (TypeMap.getChatConstructor(attachmentJson['attach_type']))(this.Channel, this.Sender, attachmentJson['attach_type'], this.MessageId, this.LogId, this.PrevLogId, this.SendTime, this.Text, attachmentJson['attach_content']);
            attachmentList.push(...contentChat.AttachmentList);
        }
        if (attachmentJson['attach_only'])
            this.contentOnly = true;
    }
}
exports.ReplyChat = ReplyChat;
class CustomChat extends Chat {
    get Type() {
        return chat_type_1.ChatType.Custom;
    }
    get Custom() {
        return this.AttachmentList[0] || null;
    }
    readAttachment(attachmentJson, attachmentList) {
        let customAttachment = new custom_attachment_1.CustomAttachment();
        customAttachment.readAttachment(attachmentJson);
        attachmentList.push(customAttachment);
    }
}
exports.CustomChat = CustomChat;
var TypeMap;
(function (TypeMap) {
    let typeMap = new Map();
    let defaultConstructor = UnknownChat;
    function getDefaultConstructor() {
        return defaultConstructor;
    }
    TypeMap.getDefaultConstructor = getDefaultConstructor;
    function getChatConstructor(type) {
        return typeMap.get(type) || defaultConstructor;
    }
    TypeMap.getChatConstructor = getChatConstructor;
    typeMap.set(chat_type_1.ChatType.Feed, FeedChat);
    typeMap.set(chat_type_1.ChatType.Text, TextChat);
    typeMap.set(chat_type_1.ChatType.Photo, SinglePhotoChat);
    typeMap.set(chat_type_1.ChatType.MultiPhoto, MultiPhotoChat);
    typeMap.set(chat_type_1.ChatType.File, FileChat);
    typeMap.set(chat_type_1.ChatType.Video, VideoChat);
    typeMap.set(chat_type_1.ChatType.Sticker, StaticEmoticonChat);
    typeMap.set(chat_type_1.ChatType.StickerAni, AnimatedEmoticonChat);
    typeMap.set(chat_type_1.ChatType.StickerGif, GifEmoticonChat);
    typeMap.set(chat_type_1.ChatType.Search, SharpSearchChat);
    typeMap.set(chat_type_1.ChatType.Map, MapChat);
    typeMap.set(chat_type_1.ChatType.Reply, ReplyChat);
    typeMap.set(chat_type_1.ChatType.Custom, CustomChat);
})(TypeMap = exports.TypeMap || (exports.TypeMap = {}));
//# sourceMappingURL=chat.js.map